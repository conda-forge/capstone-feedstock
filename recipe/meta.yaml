{% set version = "5.0.6" %}

package:
  name: capstone-split
  version: {{ version }}

source:
  url: https://github.com/capstone-engine/capstone/archive/{{ version }}.tar.gz
  sha256: 240ebc834c51aae41ca9215d3190cc372fd132b9c5c8aa2d5f19ca0c325e28f9
  patches:
    - patches/0001-skip-IS_APPLE-check-on-osx.patch  # [osx]
    - patches/0002-rely-on-libcapstone-do-not-smuggle-lib-headers-into-.patch
    - patches/0003-split-build-and-install-steps-for-python-use-prefix.patch

build:
  number: 2

outputs:
  - name: libcapstone
    script: install-lib.sh   # [unix]
    script: install-lib.bat  # [win]
    build:
      run_exports:
        - {{ pin_subpackage("libcapstone", max_pin="x.x.x") }}
    requirements:
      build:
        - cmake
        - make
        - {{ compiler('c') }}
        - {{ stdlib("c") }}
    test:
      commands:
        - test -f $PREFIX/lib/libcapstone${SHLIB_EXT}       # [unix]
        - if not exist %LIBRARY_BIN%\capstone.dll exit 1    # [win]
        - if not exist %LIBRARY_LIB%\capstone.lib exit 1    # [win]
        # absence of cstool
        - test ! -f $PREFIX/bin/cstool                      # [unix]
        - if exist %LIBRARY_BIN%\cstool.exe exit 1          # [win]

  - name: cstool
    script: install-lib.sh   # [unix]
    script: install-lib.bat  # [win]
    build:
      run_exports:
        - {{ pin_subpackage("libcapstone", max_pin="x.x.x") }}
    requirements:
      build:
        - cmake
        - make
        - {{ compiler('c') }}
        - {{ stdlib("c") }}
      host:
        - {{ pin_subpackage('libcapstone', exact=True) }}
      run:
        - {{ pin_subpackage('libcapstone', exact=True) }}
    test:
      commands:
        - cstool -v

  - name: capstone
    script: install-py.sh  # [unix]
    script: install-py.bat  # [win]
    requirements:
      build:
        - python                                 # [build_platform != target_platform]
        - cross-python_{{ target_platform }}     # [build_platform != target_platform]
        - cython                                 # [build_platform != target_platform]
        - {{ compiler('c') }}
        - {{ stdlib("c") }}
        - make
        - cmake
      host:
        - python
        - pip
        - cython
        - pthread-stubs
        - {{ pin_subpackage('libcapstone', exact=True) }}
        - setuptools
      run:
        - python
        - setuptools
        - importlib_resources
        - {{ pin_subpackage('libcapstone', exact=True) }}
    test:
      source_files:
        - bindings/python/tests/
      imports:
        - capstone
      requires:
        - pip
      commands:
        - pip check
        - python bindings/python/tests/test_all.py
        # absence of library & headers in site-packages
        - test ! -f $SP_DIR/capstone/include/capstone/x86.h         # [unix]
        - test ! -f $SP_DIR/capstone/lib/libcapstone.so             # [linux]
        - test ! -f $SP_DIR/capstone/lib/libcapstone.dylib          # [osx]
        - if exist %SP_DIR%\capstone\include\capstone\x86.h exit 1  # [win]
        - if exist %SP_DIR%\capstone\lib\capstone.dll exit 1        # [win]

about:
  home: http://www.capstone-engine.org/
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE.TXT
  summary: The Ultimate Disassembler
  description: |
    Capstone is a lightweight multi-platform, multi-architecture disassembly framework
  doc_url: http://www.capstone-engine.org/documentation.html
  dev_url: https://github.com/capstone-engine/capstone

extra:
  feedstock-name: capstone
  recipe-maintainers:
    - scopatz
    - CJ-Wright
    - thewchan
    - xhochy
